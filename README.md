# 모터 드라이브 제어 방법

## 명령어 읽기/쓰기 규칙
| 기능  | 명령   | 응답   | 설명               |
|-----|------|------|------------------|
| 읽기  | 0x40 | 0x4F | 1 Byte 데이터 읽기 성공 |
| 읽기  | 0x40 | 0x4B | 2 Byte 데이터 읽기 성공 |
| 읽기  | 0x40 | 0x43 | 4 Byte 데이터 읽기 성공 |
| 쓰기  | 0x2F | 0x60 | 1 Byte 데이터 쓰기 성공 |
| 쓰기  | 0x2B | 0x60 | 2 Byte 데이터 쓰기 성공 |
| 쓰기  | 0x23 | 0x60 | 4 Byte 데이터 쓰기 성공 |
| 에러  | -    | 0x80 | 에러 발생            |

* 데이터 읽기 명령은 0x40으로 시작, 응답은 데이터 크기에 따라 다름
* 데이터 쓰기 명령은 데이터 크기에 따라 다름, 응답은 0x60 고정
``` yaml
쓰기 예시: Node-ID 2번 드라이버의 Control Word(0x6040)에 'Servo On' 명령(0x000F) 쓰기

    제어기 → 드라이버 (요청):
        COB-ID: 0x602
        Data: 2B 40 60 00 0F 00 00 00
            2B: 2바이트 쓰기 명령
            40 60: Index 0x6040 (Little-endian)
            00: Sub-index 0x00
            0F 00 00 00: 데이터 0x000F (Little-endian)
    드라이버 → 제어기 (응답):
        COB-ID: 0x582
        Data: 60 40 60 00 00 00 00 00
            60: 쓰기 성공 응답
            40 60 00: 요청했던 주소 확인
```

``` yaml
읽기 예시: Node-ID 2번 드라이버의 Status Word(0x6041) 값 읽기

    제어기 → 드라이버 (요청):
        COB-ID: 0x602
        Data: 40 41 60 00 00 00 00 00
            40: 읽기 명령
            41 60: Index 0x6041 (Little-endian)
            00: Sub-index 0x00
    드라이버 → 제어기 (응답): (만약 Status Word 값이 0x1237 이라면)
        COB-ID: 0x582
        Data: 4B 41 60 00 37 12 00 00
            4B: 2바이트 읽기 성공 응답
            41 60 00: 요청했던 주소 확인
            37 12 00 00: 읽어온 데이터 0x1237 (Little-endian)
```


## 에러 코드
내용 추가 필요


## Control Word (0x6040)

| 15          | 14        | 13                     | 12            | 11               | 10         | 9              | 8         |
|-------------|-----------|------------------------|---------------|------------------|------------|----------------|-----------|
|             |           |                        |               |                  |            |                | Halt      |
| 7           | 6         | 5                      | 4             | 3                | 2          | 1              | 0         |
| Fault Reset | Abs / Rel | Change set immediately | New Set-Point | Enable Operation | Quick Stop | Enable Voltage | Switch On |

* Switch On
  * 드라이버의 전원을 켜는 상태로 전환


* Enable Voltage
  * 0: 전압 공급 비활성화
  * 1: 전압 공급 활성화


* Quick Stop
  * 0: 퀵스탑 활성화 (설정된 퀵스탑 프로파일에 따라 정지 -> 0x605A)
  * 1: 퀵스탑 비활성화


* Enable Operation
  * 0: 서보 OFF
  * 1: 서보 ON


* Fault Reset
  * 1: 오류 초기화
  * **0에서 1로 변경시 오류 초기화**


* Halt
  * 0: 서보 일시 정지 명령
  * 1: 서보 일시 정지 해제 명령


* 6~4 bit
  * 위치 제어 모드 상태 일때 사용할 수 있는 비트
  * Abs/Rel:
    * 0: 절대 위치 제어
    * 1: 상대 위치 제엉
  * Change set immediately:
    * 0: 현재 이동 중인 목표 위치 도착 후 다음 목표 위치로 이동
    * 1: 즉시 목표 위치로 이동
  * New Set-Point:
    * 1: 새로운 목표 위치 값을 입력하고 이 비트가 Rising Edge로 설정된 경우 즉시 목표 위치로 이동
  * 호밍 모드에서 4비트는 Homing Operation Start
    * 1: 호밍 시작

<br>
<br>
<br>

## Status Word (0x6041)

| 15 | 14                 | 13            | 12             | 11                    | 10               | 9         | 8                  |
|---|--------------------|---------------|----------------|-----------------------|------------------|-----------|--------------------|
|   |                    | Mode Specific | Mode Specific  | Position Limit Active | Target Reached   | Remote    | Mode Specific      |
| 7 | 6                  | 5             | 4              | 3                     | 2                | 1         | 0                  |
| 0 | Switch On Disabled | Quick Stop    | Voltage Output | Fault                 | Operation Enable | Switch On | Ready to Switch On |


* [8 bit] 
  * (위치/호밍 모드) Abnomaly Stop
  * (속도/토크 모드) -


* [10 bit] Target reached
  * (위치/호밍 모드) '1'이면 목표 위치에 성공적으로 도달했음
  * (속도/토크 모드) '1'이면 목표 속도/토크에 도달했음


* [11 bit]  Position limit active
  * 내부 리미트에 도달했음
  

* [12 bit] Set-point acknowledge 또는 Homing attained
  * (위치 모드) '1'이면 새로운 목표 위치 값을 정상적으로 수신했음
  * (속도 모드) '1'이면 속도가 0임
  * (호밍 모드) '1'이면 원점 복귀가 성공적으로 완료


* [13 bit] Following error 또는 Homing error
  * (위치 모드) '1'이면 지령 위치와 실제 위치 간의 편차가 너무 커서 추종 에러가 발생했음
  * (호밍 모드) '1'이면 원점 복귀 중 오류가 발생했음

<br>
<br>
<br>

## 모터 구동을 위한 상태 전환 순서
| 순서 | 상태                 | 명령어                           | hex       |
|----|--------------------|-------------------------------|-----------|
| 1  | Switch on Disabled | 전원 인가 직후 초기 상태                | 0000 0000 |
| 2  | Ready to Swich On  | 60X 8 2B 40 60 00 06 00 00 00 | 0000 0110 |
| 3  | Switch On          | 60X 8 2B 40 60 00 07 00 00 00 | 0000 0111 |
| 4  | Operation Enabled  | 60X 8 2B 40 60 00 0F 00 00 00 | 0000 1111 |

* Operation Enabled를 Servo On/Off로 보면됨


<br>
<br>
<br>

## 제어 모드 설정
| 모드    | 모드 코드  | 명령어                            |
|-------|--------|--------------------------------|
| 위치 모드 | 0x01   | 60X 8 2F 60 60 01 00 00 00 00  |
| 속도 모드 | 0x02   | 60X 8 2F 60 60 03 00 00 00 00  |
| 토크 모드 | 0x03   | 60X 8 2F 60 60 05 00 00 00 00  |
| 호밍 모드 | 0x05   | 60X 8 2F 60 60 07 00 00 00 00  |

<br>
<br>
<br>

## 위치 제어 방법
| 이름      | 명령어                                                              | 설명                                          |
|---------|------------------------------------------------------------------|---------------------------------------------|
| 속도 설정   | 60X 8 2F 81 60 01 XX XX XX XX                                    | 단위 Pulse/s                                  |
| 가속도 설정  | 60X 8 23 83 60 00 XX XX XX XX                                    | 단위 Pulse/s^2                                |
| 감속도 설정  | 60X 8 23 84 60 00 XX XX XX XX                                    | 단위 Pulse/s^2                                |
| 목표 위치 설정 | 60X 8 23 7A 60 00 XX XX XX XX                                    | 단위 Pulse                                    |
| 상대 위치 제어 | 60X 8 2B 40 60 00 4F 00 00 00 <br> 60X 8 2B 40 60 00 5F 00 00 00 | Abs/Rel을 1로 설정 <br>New set-point을 1로 설정(동작) |
| 절대 위치 제어 | 60X 8 2B 40 60 00 0F 00 00 00 <br> 60X 8 2B 40 60 00 1F 00 00 00 | Abs/Rel을 0으로 설정 <br>New set-position을1로 설정(동작)|


* 제어모드를 위치 제어 모드로 먼저 설정해야함
* 위치 모드 전용 속도 설정임 (속도 제어용은 따로 있음)
* 가속도 설정은 공유함
* 절대 위치 제어시 배터리 캐이블을 장착 해야 엔코더 값이 저장됨

<br>
<br>
<br>

## 속도 제어 명령어
| 이름       | 명령어                           | 설명           |
|----------|-------------------------------|--------------|
| 목표 속도 설정 | 60X 8 23 FF 60 00 XX XX XX XX | 단위 Pulse/s^2 |
| 가속도 설정   | 60X 8 23 83 60 00 XX XX XX XX | 단위 Pulse/s^2 |
| 감속도 설정   | 60X 8 23 84 60 00 XX XX XX XX | 단위 Pulse/s^2 |

* 목표 속도를 설정하는 즉시 동작함

<br>
<br>
<br>

## WatchDog 명령어
| 이름           | 명령어                           | 설명            |
|--------------|-------------------------------|---------------|
| WatchDog 설정  | 60X 8 2B 04 50 06 00 00 00 00 | 와치독 비활성화 (0ms) |
| WatchDog 활성화 | 60X 8 2B 04 50 06 XX XX XX XX | 와치독 활성화 (ms) |
| WatchDog 설정 저장 | 60X 8 23 10 10 04 73 61 76 55 | 설정값 저장 |

* 와치독 에러 해소 방법
  1. NMT 상태를 pre-operation으로 설정 -> 000 1 80
  2. 와치독 타임아웃 0으로 설정
  3. 설정값 저장
  4. Servo On

<br>
<br>
<br>

## Fault Clear 명령어
| 이름           | 명령어                                                                   | 설명                             |
|--------------|-----------------------------------------------------------------------|--------------------------------|
| Fault Clear   | 60X 8 2B 40 60 00 00 00 00 00 <br> 60X 8 2B 40 60 00 80 00 00 00 <br> | 모든 비트 0으로 설정<br>7비트를 0에서 1로 설정 |



## 앱솔루트 엔코더 설정
|이름| 명령어 | 설명                                  |
|--|--|-------------------------------------|
|상대 위치 제어|| 0x2633 멀티너위치 값 활성화 성정 이 값을 0x20으로 설정 |
||| Pa0.15를 0x09로 설정하면 초기 위치 설정 완료      |